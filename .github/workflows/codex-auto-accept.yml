name: Codex Auto-Accept (Prefer PR, backup base)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr:
        description: "Pull request number"
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  auto_accept:
    # Sadece yorum PR üzerinde ve '/codex-accept' içeriyorsa, ya da elle tetiklendiyse koş
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request != null &&
       contains(github.event.comment.body, '/codex-accept')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR number
        id: prnum
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "n=${{ github.event.inputs.pr }}" >> $GITHUB_OUTPUT
          else
            echo "n=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const n = Number(core.getInput('n')) || Number('${{ steps.prnum.outputs.n }}')
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: n
            })
            core.setOutput('base', pr.base.ref)  // örn: main
            core.setOutput('head', pr.head.ref)  // örn: codex/...
            core.setOutput('number', String(n))

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.base }}
          fetch-depth: 0

      - name: Setup git identity
        run: |
          git config user.name "codex-auto"
          git config user.email "actions@users.noreply.github.com"

      - name: Fetch PR head
        run: |
          git fetch origin "${{ steps.pr.outputs.head }}:${{ steps.pr.outputs.head }}"

      - name: Backup current base (zip as artifact)
        run: |
          ts=$(date +'%Y-%m-%d_%H-%M-%S')
          mkdir -p .codex-backups
          git ls-files -z | xargs -0 zip -qq ".codex-backups/base-backup-$ts.zip"
        shell: bash

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: base-backup-${{ steps.pr.outputs.base }}-${{ steps.pr.outputs.number }}
          path: .codex-backups/*.zip
          retention-days: 14

      - name: Merge PR into base preferring PR (theirs)
        run: |
          git merge -X theirs "origin/${{ steps.pr.outputs.head }}" -m "Auto-merge: prefer PR (Codex) changes"
          git push origin "HEAD:${{ steps.pr.outputs.base }}"

      - name: Comment success
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.pr.outputs.number }}"),
              body: "✅ Codex auto-accept çalıştı: PR içeriği **${{ steps.pr.outputs.base }}** dalına yazıldı. Yedek artifact'te."
            })
